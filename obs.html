<!-- Config Node -->
<script type="text/javascript">
    RED.nodes.registerType("obs-instance", {
        category: "config",
        defaults: {
            name: {value: "OBS Instance", required: false},
            host: {value: "127.0.0.1", required: true},
            port: {value: 4455, required: true, validate: RED.validators.number()}
        },
        credentials: {
            password: {type: "password"}
        },
        label: function() {
            return this.name||`ws://${this.host}:${this.port}`;
        }
    });
</script>

<script type="text/html" data-template-name="obs-instance">
    <div class="form-row">
        <label for="node-config-input-host"><i class="fa fa-globe"></i> Host/IP</label>
        <input type="text" id="node-config-input-host">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="fa fa-globe"></i> Port</label>
        <input type="text" id="node-config-input-port">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="fa fa-key"></i> Password</label>
        <input type="password" id="node-config-input-password" placeholder="(optional)">
    </div>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="obs-instance">
    <h3>Details</h3>
        <p>This node represents a single connection to the obs websocket server.</p>
        <p><code>Host/IP</code> is the ip address or hostname of the device running obs.</p>
        <p><code>Port</code> is the configured websocket port in the obs-websocket settings. Default is 4455.</p>
        <p><code>Password</code> is the configured passwort in the obs-websocket settings.</p>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket">obs-websocket</a> - GitHub project page</li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END Config Node -->

<!-- obs connection status -->
<script type="text/javascript">
    RED.nodes.registerType("obs connection status", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 0,
        outputs: 1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name||"obs connection status";
        }
    });
</script>

<script type="text/html" data-template-name="obs connection status">
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="obs connection status">
    <p>This node shows and outputs the obs connection status.</p>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <dl class="message-properties">
            <dt>payload <span class="property-type">string</span></dt>
            <dd>One of: "ConnectionOpened", "Identified", "AuthenticationFailure", "ConnectionClosed"</dd>
        </dl>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END obs connection status -->

<!-- obs event -->
<script type="text/javascript">
    RED.nodes.registerType("obs event", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            event: {value: "", required: true},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 0,
        outputs: 1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name||(this.event.split(",").length==1 && this.event)||"obs events";
        },
        oneditprepare: function() {
            $("#node-input-event").typedInput({type:"event", types:[{
                value: "event",
                multiple: true,
                options: websocketEventTypes.map(e => { return {value: e, text: e} })
            }]});

            // Handle docs button click
            $("#node-input-windowBlockedText").hide();
            $("#node-input-event").on("change", function(event, type, value) {
                $("#node-input-obsws-docs").off("click");
                $("#node-input-obsws-docs").on("click", function() {
                    value.split(",").forEach(prop => {
                        let win = window.open(`https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md#${prop.toLowerCase()}`, "_blank");
                        if (!win) $("#node-input-windowBlockedText").show();
                    });
                })
            });
        }
    });

    const websocketEventTypes = [
        "CurrentSceneCollectionChanging","CurrentSceneCollectionChanged","SceneCollectionListChanged",
        "CurrentProfileChanging","CurrentProfileChanged","ProfileListChanged","SourceFilterListReindexed",
        "SourceFilterCreated","SourceFilterRemoved","SourceFilterNameChanged","SourceFilterEnableStateChanged",
        "ExitStarted","InputCreated","InputRemoved","InputNameChanged","InputActiveStateChanged","InputShowStateChanged",
        "InputMuteStateChanged","InputVolumeChanged","InputAudioBalanceChanged","InputAudioSyncOffsetChanged",
        "InputAudioTracksChanged","InputAudioMonitorTypeChanged","InputVolumeMeters","MediaInputPlaybackStarted",
        "MediaInputPlaybackEnded","MediaInputActionTriggered","StreamStateChanged","RecordStateChanged",
        "ReplayBufferStateChanged","VirtualcamStateChanged","ReplayBufferSaved","SceneItemCreated","SceneItemRemoved",
        "SceneItemListReindexed","SceneItemEnableStateChanged","SceneItemLockStateChanged","SceneItemSelected",
        "SceneItemTransformChanged","SceneCreated","SceneRemoved","SceneNameChanged","CurrentProgramSceneChanged",
        "CurrentPreviewSceneChanged","SceneListChanged","CurrentSceneTransitionChanged","CurrentSceneTransitionDurationChanged",
        "SceneTransitionStarted","SceneTransitionEnded","SceneTransitionVideoEnded","StudioModeStateChanged",
        "VendorEvent"
    ];
</script>

<script type="text/html" data-template-name="obs event">
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-event">Event</label>
        <input type="text" id="node-input-event" style="width: calc(70.5% - 47px);"></select>
        <a id="node-input-obsws-docs" class="red-ui-button" style="margin-left: 10px;" title="Open obs-websocket docs"><i class="fa fa-book"></i></a>
    </div>
    <div class="form-tips" id="node-input-windowBlockedText" style="margin-bottom: 10px">
        <b>Attention:</b> Some documentation pages could not be opened, make sure to allow popups for this page.
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="obs event">
    <p>This node outputs event messages based on the configured event type.</p>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <dl class="message-properties">
            <dt>topic <span class="property-type">string</span></dt>
            <dd>The event name</dd>
        </dl>
        <dl class="message-properties">
            <dt>payload <span class="property-type">object</span></dt>
            <dd>The event object as emitted by obs-websocket</dd>
        </dl>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md#events">obs-websocket API docs</a> - full description of <code>msg.payload</code></li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END obs event -->

<!-- obs request -->
<script type="text/javascript">
    RED.nodes.registerType("obs request", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            reqType: {value:"", required: true},
            reqTypeType: {value:"", required: true},
            reqData: {value:""},
            reqDataType: {value:"", required: true},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 1,
        outputs: 2,
        icon: "font-awesome/fa-cogs",
        outputLabels: ["result", "error"],
        label: function() {
            return this.name || (["str", "requestName"].includes(this.reqTypeType) && this.reqType) || "obs request";
        },
        oneditprepare: function() {
            let noneTypeDef = {
                value: "none",
                label: "None",
                hasValue: false,
                icon: "fa fa-times-circle-o"
            };
            let requestsTypeDef = {
                    value: "requestName",
                    label: "Request",
                    hasValue: false,
                    icon: "fa fa-list",
                    options: websocketAddRequestTypesFlat
            };

            // Initialize typedInput for requestType
            $("#node-input-reqType").typedInput({
                default: "msg",
                types: ["str", requestsTypeDef, "msg", "flow", "global"],
                typeField: $("#node-input-reqTypeType")
            });
            // Set default values if none set
            if (!this.reqType) {
                $("#node-input-reqType").typedInput("type", "requestName");
            }

            // Initialize typedInput for requestData
            $("#node-input-reqData").typedInput({
                types: [noneTypeDef, "msg", "flow", "global", "json"],
                typeField: $("#node-input-reqDataType")
            });
            // Set default values if none set
            if (!this.reqData) {
                $("#node-input-reqData").typedInput("type", "none");
            }

            const obsWsDocsUrl = "https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md";
            $("#node-input-windowBlockedText").hide();
            $("#node-input-reqType").on("change", function(event, type, value) {
                // Handle AutoComplete
                if (type == "str") {
                    $("#node-input-reqType").next(".red-ui-typedInput-container").find(".red-ui-typedInput-input").autoComplete({
                        search: function(val) {
                            let matches = [];
                            websocketAddRequestTypesFlat.forEach((v, i) => {
                                if (v.toLowerCase().includes(val.toLowerCase())) {
                                    matches.push({
                                        value: v,
                                        label: v,
                                        i: i
                                    });
                                }
                            });
                            return matches;
                        }
                    })
                }

                // Handle display of requestData TypedInput
                if (!(["str", "requestName"].includes(type) && value in websocketAllRequestTypes && !websocketAllRequestTypes[value])) {
                    $("#node-input-reqDataDiv").show();
                } else {
                    $("#node-input-reqData").typedInput("type", "none");
                    $("#node-input-reqDataDiv").hide();
                }

                // Handle docs button click
                $("#node-input-obsws-docs").off("click");
                $("#node-input-obsws-docs").on("click", function() {
                    let win = window.open(`${obsWsDocsUrl}#${["str", "requestName"].includes(type) && websocketAddRequestTypesFlat.includes(value) ? value.toLowerCase() : "requests"}`, "_blank");
                    if (!win) $("#node-input-windowBlockedText").show();
                });

                // Handle invalid requestType message
                $("#node-input-requestNameInvalidText").hide();
                if (type == "str" && !websocketAddRequestTypesFlat.includes(value)) $("#node-input-requestNameInvalidText").show();
            });
        }
    });

    const websocketAllRequestTypes = {
        "GetPersistentData":true,"SetPersistentData":true,"GetSceneCollectionList":false,"SetCurrentSceneCollection":true,
        "CreateSceneCollection":true,"GetProfileList":false,"SetCurrentProfile":true,"CreateProfile":true,
        "RemoveProfile":true,"GetProfileParameter":true,"SetProfileParameter":true,"GetVideoSettings":false,
        "SetVideoSettings":true,"GetStreamServiceSettings":false,"SetStreamServiceSettings":true,
        "GetRecordDirectory":false,"GetSourceFilterList":true,"GetSourceFilterDefaultSettings":true,
        "CreateSourceFilter":true,"RemoveSourceFilter":true,"SetSourceFilterName":true,"GetSourceFilter":true,
        "SetSourceFilterIndex":true,"SetSourceFilterSettings":true,"SetSourceFilterEnabled":true,
        "GetVersion":false,"GetStats":false,"BroadcastCustomEvent":true,"CallVendorRequest":true,
        "GetHotkeyList":false,"TriggerHotkeyByName":true,"TriggerHotkeyByKeySequence":true,"GetInputList":true,
        "GetInputKindList":true,"GetSpecialInputs":false,"CreateInput":true,"RemoveInput":true,
        "SetInputName":true,"GetInputDefaultSettings":true,"GetInputSettings":true,"SetInputSettings":true,
        "GetInputMute":true,"SetInputMute":true,"ToggleInputMute":true,"GetInputVolume":true,"SetInputVolume":true,
        "GetInputAudioBalance":true,"SetInputAudioBalance":true,"GetInputAudioSyncOffset":true,
        "SetInputAudioSyncOffset":true,"GetInputAudioMonitorType":true,"SetInputAudioMonitorType":true,
        "GetInputAudioTracks":true,"SetInputAudioTracks":true,"GetInputPropertiesListPropertyItems":true,
        "PressInputPropertiesButton":true,"GetMediaInputStatus":true,"SetMediaInputCursor":true,
        "OffsetMediaInputCursor":true,"TriggerMediaInputAction":true,"GetVirtualCamStatus":false,
        "ToggleVirtualCam":false,"StartVirtualCam":false,"StopVirtualCam":false,"GetReplayBufferStatus":false,
        "ToggleReplayBuffer":false,"StartReplayBuffer":false,"StopReplayBuffer":false,"SaveReplayBuffer":false,
        "GetLastReplayBufferReplay":false,"GetOutputList":false,"GetOutputStatus":true,"ToggleOutput":true,
        "StartOutput":true,"StopOutput":true,"GetOutputSettings":true,"SetOutputSettings":true,
        "GetRecordStatus":false,"ToggleRecord":false,"StartRecord":false,"StopRecord":false,"ToggleRecordPause":false,
        "PauseRecord":false,"ResumeRecord":false,"GetSceneItemList":true,"GetGroupSceneItemList":true,
        "GetSceneItemId":true,"CreateSceneItem":true,"RemoveSceneItem":true,"DuplicateSceneItem":true,
        "GetSceneItemTransform":true,"SetSceneItemTransform":true,"GetSceneItemEnabled":true,"SetSceneItemEnabled":true,
        "GetSceneItemLocked":true,"SetSceneItemLocked":true,"GetSceneItemIndex":true,"SetSceneItemIndex":true,
        "GetSceneItemBlendMode":true,"SetSceneItemBlendMode":true,"GetSceneList":false,"GetGroupList":false,
        "GetCurrentProgramScene":false,"SetCurrentProgramScene":true,"GetCurrentPreviewScene":false,
        "SetCurrentPreviewScene":true,"CreateScene":true,"RemoveScene":true,"SetSceneName":true,
        "GetSceneSceneTransitionOverride":true,"SetSceneSceneTransitionOverride":true,"GetSourceActive":true,
        "GetSourceScreenshot":true,"SaveSourceScreenshot":true,"GetStreamStatus":false,"ToggleStream":false,
        "StartStream":false,"StopStream":false,"SendStreamCaption":true,"GetTransitionKindList":false,
        "GetSceneTransitionList":false,"GetCurrentSceneTransition":false,"SetCurrentSceneTransition":true,
        "SetCurrentSceneTransitionDuration":true,"SetCurrentSceneTransitionSettings":true,"GetCurrentSceneTransitionCursor":false,
        "TriggerStudioModeTransition":false,"SetTBarPosition":true,"GetStudioModeEnabled":false,
        "SetStudioModeEnabled":true,"OpenInputPropertiesDialog":true,"OpenInputFiltersDialog":true,
        "OpenInputInteractDialog":true,"GetMonitorList":false,"OpenVideoMixProjector":true,"OpenSourceProjector":true
    };
    const websocketAddRequestTypesFlat = Object.keys(websocketAllRequestTypes);
</script>

<script type="text/html" data-template-name="obs request">
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-reqType">Request Type</label>
        <input type="text" id="node-input-reqType" style="width:calc(70.5% - 47px)" class="red-ui-autoComplete">
        <input type="hidden" id="node-input-reqTypeType">
        <a id="node-input-obsws-docs" class="red-ui-button" style="margin-left: 10px;" title="Open obs-websocket docs"><i class="fa fa-book"></i></a>
    </div>
    <div class="form-tips" id="node-input-windowBlockedText" style="margin-bottom: 10px">
        <b>Attention:</b> The documentation page could not be opened, make sure to allow popups for this page.
    </div>
    <div class="form-tips" id="node-input-requestNameInvalidText" style="margin-bottom: 10px">
        <b>Attention:</b> The current Request Type is unknown and will probably not work if you try.
    </div>
    <div class="form-row" id="node-input-reqDataDiv">
        <label for="node-input-reqData">Request Data</label>
        <input type="text" id="node-input-reqData" style="width:70%" class="red-ui-autoComplete">
        <input type="hidden" id="node-input-reqDataType">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="obs request">
    <p>This node runs a obs-websocket request and returns it's result(which can be nothing!) or error.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">topic (optional/configurable) <span class="property-type">string</span></dt>
        <dd>The request name.</dd>
    </dl>
    <dl class="message-properties">
        <dt class="optional">payload (optional/configurable) <span class="property-type">object</span></dt>
        <dd>Additional "Data Fields".</dd>
    </dl>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>result output
            <dl class="message-properties">
                <dt>payload <span class="property-type">object or undefined</span></dt>
                <dd>The result of the request.</dd>
            </dl>
            <dl class="message-properties">
                <dt>topic <span class="property-type">string</span></dt>
                <dd>The request name.</dd>
            </dl>
        </li>
        <li>error output
            <dl class="message-properties">
                <dt>payload <span class="property-type">string</span></dt>
                <dd>The obs-websocket error.</dd>
            </dl>
        </li>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md#requests">obs-websocket API docs</a> for the requests and data fields</li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END obs request -->

<!-- SetCurrentProgramScene -->
<script type="text/javascript">
    RED.nodes.registerType("SetCurrentProgramScene", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            scene: {value: "Scene 1", required: true},
            sceneType: {value: "", required: true},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name||"SetCurrentProgramScene";
        },
        oneditprepare: function() {
            let scenesTypeDef = {
                    value: "sceneName",
                    label: "Scene",
                    hasValue: false,
                    icon: "fa fa-list",
                    options: null
            };
            let sceneTypedInputObj = {
                default: "str",
                typeField: $("#node-input-sceneType"),
                types: ["str", "jsonata", "msg", "flow", "global"]
            }

            // Hide/show warning messages as needed
            $("#node-input-scs-offlinemessage").hide();
            $("#node-input-scs-redeploymessage").hide();
            if (!this.obsInstance) $("#node-input-scs-redeploymessage").show();

            // http request to backend for obs scene list
            $.getJSON(`nr-contrib-obs-ws/${this.obsInstance}/list/scenes`, data => {
                scenesTypeDef.options = data.scenes.reverse().map(s => s.sceneName); // Works because object reference is kept when putting inside sceneTypedInputObj
            }).fail(() => { // 503 = obs not connected
                if (this.sceneType == "sceneName" && this.scene !== "") scenesTypeDef.options = [this.scene];
                $("#node-input-scs-offlinemessage").show();
            }).always(() => {
                if (scenesTypeDef.options) {
                    sceneTypedInputObj.types.splice(0, 0, scenesTypeDef)
                    sceneTypedInputObj.default = "sceneName";
                }
                $("#node-input-scene").typedInput(sceneTypedInputObj);
            });
        }
    });
</script>

<script type="text/html" data-template-name="SetCurrentProgramScene">
    <div class="form-tips" id="node-input-scs-offlinemessage" style="color:red;display:none;margin-bottom: 10px">
        Not connected to obs! Unable to fetch scenes.
    </div>
    <div class="form-tips" id="node-input-scs-redeploymessage" style="color:red;display:none;margin-bottom: 10px">
        To access available obs scenes, please select a valid OBS Instance, redeploy and open this again.
    </div>
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-scene">Scene Name</label>
        <input type="text" id="node-input-scene" style="width:70%" class="red-ui-autoComplete">
        <input type="hidden" id="node-input-sceneType">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="SetCurrentProgramScene">
    <p>This node switches the scene in obs.</p>
    <p>Use a catch node to catch request errors. (optional)</p>
    <p>To automatically fetch available scenes from obs, make sure your obs is running and you deployed the node at least once after adding it.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">payload (configurable) <span class="property-type">string</span></dt>
        <dd>The scene name.</dd>
    </dl>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <dl class="message-properties">
            <dt>payload <span class="property-type">string</span></dt>
            <dd>The selected scene name if successful.</dd>
        </dl>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md#setcurrentprogramscene">obs-websocket API docs</a> for this request</li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END SetCurrentProgramScene -->

<!-- TriggerStudioModeTransition -->
<script type="text/javascript">
    RED.nodes.registerType("TriggerStudioModeTransition", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            transition: {value: ""},
            transitionType: {value: ""},
            transitionTime: {value: ""},
            transitionTimeType: {value: ""},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name||"TriggerStudioModeTransition";
        },
        oneditprepare: function() {
            let noneTypeDef = {
                value: "none",
                label: "None",
                hasValue: false,
                icon: "fa fa-times-circle-o"
            };
            var transitionTypeDef = {
                    value: "transition",
                    label: "Transition",
                    hasValue: false,
                    icon: "/red/images/typedInput/bool.svg",
                    options: null
            };
            let transitionTypedInputObj = {
                default: "none",
                typeField: "#node-input-transitionType",
                types: [noneTypeDef, "str", "msg", "flow", "global"]
            };

            // Hide/show warning messages as needed
            $("#node-input-tsmt-offlinemessage").hide();
            $("#node-input-tsmt-redeploymessage").hide();
            if (!this.obsInstance) $("#node-input-tsmt-redeploymessage").show();

            // http request to backend for obs transition list
            $.getJSON(`nr-contrib-obs-ws/${this.obsInstance}/list/transitions`, (data) => {
                transitionTypeDef.options = data.transitions.map(s => s.transitionName);
            }).fail(() => { //503 = obs not connected
                if (this.transitionType == "transition" && this.transition !== "") transitionTypeDef.options = [this.transition];
                $("#node-input-tsmt-offlinemessage").show();
            }).always(() => {
                if (transitionTypeDef.options) transitionTypedInputObj.types.splice(1, 0, transitionTypeDef);
                $("#node-input-transition").typedInput(transitionTypedInputObj);
            });

            $("#node-input-transitionTime").typedInput({
                default: "none",
                typeField: "#node-input-transitionTimeType",
                types: [noneTypeDef, "num", "jsonata", "msg", "flow", "global"]
            });

            // Hide and show transition time setting on transition settings change
            $("#node-input-transition").on('change', (type, value) => {
                value == "none" ? $("#ttp-transistionTime").hide() : $("#ttp-transistionTime").show();
            });
        }
    });
</script>

<script type="text/html" data-template-name="TriggerStudioModeTransition">
    <div class="form-tips" id="node-input-tsmt-offlinemessage" style="color:red;display:none;margin-bottom: 10px">
        Not connected to obs! Unable to fetch transitions.
    </div>
    <div class="form-tips" id="node-input-tsmt-redeploymessage" style="color:red;display:none;margin-bottom: 10px">
        To access available obs transitions, please select a valid OBS Instance, redeploy and open this again.
    </div>
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-transition">Transition</label>
        <input type="text" id="node-input-transition" style="width:70%" class="red-ui-autoComplete">
        <input type="hidden" id="node-input-transitionType">
    </div>
    <div class="form-row" id="ttp-transistionTime">
        <label for="node-input-transition">Transition Time</label>
        <input type="text" id="node-input-transitionTime" style="width:70%" class="red-ui-autoComplete">
        <input type="hidden" id="node-input-transitionTimeType">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="TriggerStudioModeTransition">
    <p>This node triggers the transition to program action which will take the current preview scene to program.</p>
    <p>By automatically sending 2 different requests before that it can optionally change the transition and set it's duration.</p>
    <p>It's the same action that happens in obs when pressing the "Transition" button in studio mode.</p>
    <p>To automatically fetch available transitions from obs make sure your obs is running and you deployed the node at least once after adding it.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">transition (configurable) <span class="property-type">string</span></dt>
        <dd>The optional transition name to use.</dd>
        <dt class="optional">transitionTime (configurable) <span class="property-type">string</span></dt>
        <dd>The optional transition time to use for the specified transition.</dd>
    </dl>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <p>The incoming msg.</p>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md#triggerstudiomodetransition">obs-websocket API docs</a> for this request</li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END TriggerStudioModeTransition -->