<!-- Config Node -->
<script type="text/javascript">
    RED.nodes.registerType("obs-instance", {
        category: "config",
        defaults: {
            name: {value: "OBS Instance", required: false},
            host: {value: "127.0.0.1", required: true},
            port: {value: 4455, required: true, validate: RED.validators.number()}
        },
        credentials: {
            password: {type: "password"}
        },
        label: function() {
            return this.name||`ws://${this.host}:${this.port}`;
        }
    });
</script>

<script type="text/html" data-template-name="obs-instance">
    <div class="form-row">
        <label for="node-config-input-host"><i class="fa fa-globe"></i> Host/IP</label>
        <input type="text" id="node-config-input-host">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="fa fa-globe"></i> Port</label>
        <input type="text" id="node-config-input-port">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="fa fa-key"></i> Password</label>
        <input type="password" id="node-config-input-password" placeholder="(optional)">
    </div>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="obs-instance">
    <h3>Details</h3>
        <p>This node represents a single connection to the obs websocket server.</p>
        <p><code>Host/IP</code> is the ip address or hostname of the device running obs.</p>
        <p><code>Port</code> is the configured websocket port in the obs-websocket settings. Default is 4455.</p>
        <p><code>Password</code> is the configured passwort in the obs-websocket settings. Leave empty if disabled.</p>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket">obs-websocket</a> - GitHub project page</li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END Config Node -->

<!-- obs event -->
<script type="text/javascript">
    RED.nodes.registerType("obs event", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            event: {value: "", required: true},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 0,
        outputs: 1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name||this.event||"obs event";
        },
        oneditprepare: function() {
            websocketEventTypes.forEach(function (item) {
                $("#node-input-event").append($("<option>", {value: item, text: item}));
            });
            $("#node-input-event").val(this.event||websocketEventTypes[0]);
        }
    });

    const websocketEventTypes = [
        "CurrentSceneCollectionChanging", "CurrentSceneCollectionChanged", "SceneCollectionListChanged",
        "CurrentProfileChanging", "CurrentProfileChanged", "ProfileListChanged", "SourceFilterListReindexed",
        "SourceFilterCreated", "SourceFilterRemoved", "SourceFilterNameChanged", "SourceFilterEnableStateChanged",
        "ExitStarted", "InputCreated", "InputRemoved", "InputNameChanged", "InputActiveStateChanged", "InputShowStateChanged",
        "InputMuteStateChanged", "InputVolumeChanged", "InputAudioBalanceChanged", "InputAudioSyncOffsetChanged",
        "InputAudioTracksChanged", "InputAudioMonitorTypeChanged", "InputVolumeMeters", "MediaInputPlaybackStarted",
        "MediaInputPlaybackEnded", "MediaInputActionTriggered", "StreamStateChanged", "RecordStateChanged",
        "ReplayBufferStateChanged", "VirtualcamStateChanged", "ReplayBufferSaved", "SceneItemCreated", "SceneItemRemoved",
        "SceneItemListReindexed", "SceneItemEnableStateChanged", "SceneItemLockStateChanged", "SceneItemSelected",
        "SceneItemTransformChanged", "SceneCreated", "SceneRemoved", "SceneNameChanged", "CurrentProgramSceneChanged",
        "CurrentPreviewSceneChanged", "SceneListChanged", "CurrentSceneTransitionChanged", "CurrentSceneTransitionDurationChanged",
        "SceneTransitionStarted", "SceneTransitionEnded", "SceneTransitionVideoEnded", "StudioModeStateChanged",
        "VendorEvent",
    ];
</script>

<script type="text/html" data-template-name="obs event">
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-event">Event</label>
        <select id="node-input-event"></select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="obs event">
    <p>This node outputs event messages based on the configured event type.</p>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <dl class="message-properties">
            <dt>payload <span class="property-type">object</span></dt>
            <dd>The event object as emitted by obs-websocket</dd>
        </dl>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket/blob/4.x-current/docs/generated/protocol.md#events">obs-websocket API docs</a> - full description of <code>msg.payload</code></li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END obs event -->

<!-- obs connection status -->
<script type="text/javascript">
    RED.nodes.registerType("obs connection status", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 0,
        outputs: 1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name||"obs connection status";
        }
    });
</script>

<script type="text/html" data-template-name="obs connection status">
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="obs connection status">
    <p>This node shows and outputs the obs connection status.</p>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <dl class="message-properties">
            <dt>payload <span class="property-type">string</span></dt>
            <dd>One of: "ConnectionOpened", "Identified", "AuthenticationFailure", "ConnectionClosed"</dd>
        </dl>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END obs connection status -->

<!-- obs request without data -->
<script type="text/javascript">
    RED.nodes.registerType("obs request without data", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            request: {value: "", required: true},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name||this.request;
        },
        oneditprepare: function() {
            websocketNoDataRequestTypes.forEach(function (item) {
                $("#node-input-request").append($("<option>", {value: item, text: item}));
            });
            $("#node-input-request").val(this.request||websocketNoDataRequestTypes[0]);
        }
    });

    const websocketNoDataRequestTypes = [
        "GetSceneCollectionList", "GetProfileList", "GetVideoSettings", "SetVideoSettings", "GetStreamServiceSettings",
        "GetRecordDirectory", "GetVersion", "GetStats", "GetHotkeyList", "TriggerHotkeyByKeySequence", "GetInputList",
        "GetInputKindList", "GetSpecialInputs", "GetVirtualCamStatus", "ToggleVirtualCam", "StartVirtualCam",
        "StopVirtualCam", "GetReplayBufferStatus", "ToggleReplayBuffer", "StartReplayBuffer", "StopReplayBuffer",
        "SaveReplayBuffer", "GetLastReplayBufferReplay", "GetOutputList", "GetRecordStatus", "ToggleRecord",
        "StartRecord", "StopRecord", "ToggleRecordPause", "PauseRecord", "ResumeRecord", "GetSceneList", "GetGroupList",
        "GetCurrentProgramScene", "GetCurrentPreviewScene", "GetStreamStatus", "ToggleStream", "StartStream",
        "StopStream", "GetTransitionKindList", "GetSceneTransitionList", "GetCurrentSceneTransition", "GetCurrentSceneTransitionCursor",
        "TriggerStudioModeTransition", "GetStudioModeEnabled", "GetMonitorList",
    ];
</script>

<script type="text/html" data-template-name="obs request without data">
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-request">Request</label>
        <select id="node-input-request"></select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="obs request without data">
    <p>This node runs a obs-websocket request that does not need any custom arguments and outputs it's result.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dd>No message data is used for the request.</dd>
    </dl>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <dl class="message-properties">
            <dt>payload <span class="property-type">object</span></dt>
            <dd>The result object of the request as specified in the obs-websocket api docs</dd>
        </dl>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket/blob/4.x-current/docs/generated/protocol.md#requests">obs-websocket API docs</a> for the response data</li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END obs request without data -->

<!-- obs raw request -->
<script type="text/javascript">
    RED.nodes.registerType("obs raw request", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            reqType: {value:"", required: true},
            reqTypeType: {value:"", required: true},
            reqData: {value:""},
            reqDataType: {value:"", required: true},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 1,
        outputs: 2,
        icon: "font-awesome/fa-cogs",
        outputLabels: ["result", "error"],
        label: function() {
            return this.name || (this.reqTypeType == "str" && this.reqType) || "obs raw request";
        },
        oneditprepare: function() {
            let noneTypeDef = {
                value: "none",
                label: "None",
                hasValue: false,
                icon: "fa fa-times-circle-o"
            };

            // Initialize typedInput for requestType
            $("#node-input-reqType").typedInput({
                default: "msg",
                types: ["str","msg","flow","global"],
                typeField: $("#node-input-reqTypeType")
            });
            // Set default values if none set
            if (!this.reqType) {
                $("#node-input-reqType").typedInput("type", "msg");
                $("#node-input-reqType").typedInput("value", "topic");
            }

            // Initialize typedInput for requestData
            $("#node-input-reqData").typedInput({
                types: [noneTypeDef,"msg","flow","global","json"],
                typeField: $("#node-input-reqDataType")
            });
            // Set default values if none set
            if (!this.reqData) {
                $("#node-input-reqData").typedInput("type", "none");
            }
        }
    });
</script>

<script type="text/html" data-template-name="obs raw request">
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-payload">Request Type</label>
        <input type="text" id="node-input-reqType" style="width:70%">
        <input type="hidden" id="node-input-reqTypeType">
    </div>
    <div class="form-row">
        <label for="node-input-payload">Request Data</label>
        <input type="text" id="node-input-reqData" style="width:70%">
        <input type="hidden" id="node-input-reqDataType">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="obs raw request">
    <p>This node runs any obs-websocket request and returns it's result or error.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">topic (configurable) <span class="property-type">string</span></dt>
        <dd>The request name.</dd>
    </dl>
    <dl class="message-properties">
        <dt class="optional">payload (configurable) <span class="property-type">object</span></dt>
        <dd>Additional "Data Fields" in json format.</dd>
    </dl>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>result output
            <dl class="message-properties">
                <dt>payload <span class="property-type">object</span></dt>
                <dd>The result of the request if successful.</dd>
            </dl>
        </li>
        <li>error output
            <dl class="message-properties">
                <dt>payload <span class="property-type">string</span></dt>
                <dd>The obs-websocket error..</dd>
            </dl>
        </li>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md#requests">obs-websocket API docs</a> for the requests and data fields</li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END obs raw request -->

<!-- SetCurrentProgramScene -->
<script type="text/javascript">
    RED.nodes.registerType("SetCurrentProgramScene", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            scene: {value: "", required: true},
            sceneType: {value: "", required: true},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name||"SetCurrentProgramScene";
        },
        oneditprepare: function() {
            let scenesTypeDef = {
                    value: "sceneName",
                    label: "Scene",
                    hasValue: false,
                    icon: "fa fa-list",
                    options: null
            };
            let sceneTypedInputObj = {
                default: "Scene",
                typeField: $("#node-input-sceneType"),
                types: [scenesTypeDef, "str","jsonata","msg","flow","global"]
            }

            // Hide/show warning messages as needed
            $("#scs-offlinemessage").hide();
            $("#scs-redeploymessage").hide();
            if (!this.obsInstance) $("#scs-redeploymessage").show();

            // http request to backend for obs scene list
            $.getJSON(`nr-contrib-obs-ws/${this.obsInstance}/list/scenes`, data => {
                scenesTypeDef.options = data.scenes.reverse().map(s => s.sceneName); // Works because object reference is kept when putting inside sceneTypedInputObj
            }).fail(() => { // 503 = obs not connected
                if (this.sceneType == "sceneName" && this.scene !== "") scenesTypeDef.options = [this.scene];
                $("#scs-offlinemessage").show();
            }).always(() => {
                $("#node-input-scene").typedInput(sceneTypedInputObj);
            });
        }
    });
</script>

<script type="text/html" data-template-name="SetCurrentProgramScene">
    <div class="form-row" style="color:red;display:none;" id="scs-offlinemessage">Not connected to obs!</div>
    <div class="form-row" style="color:red;display:none;" id="scs-redeploymessage">
        To access available obs scenes, please select a valid OBS Instance, redeploy and open this again.
    </div>
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-scene">Scene Name</label>
        <input type="text" id="node-input-scene" style="width:70%">
        <input type="hidden" id="node-input-sceneType">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="SetCurrentProgramScene">
    <p>This node switches the scene in obs.</p>
    <p>Use a catch node to catch request errors. (optional)</p>
    <p>To automatically fetch available scenes from obs, make sure your obs is running and you deployed the node at least once after adding it.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">payload (configurable) <span class="property-type">string</span></dt>
        <dd>The scene name.</dd>
    </dl>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <dl class="message-properties">
            <dt>payload <span class="property-type">string</span></dt>
            <dd>The selected scene name if successful.</dd>
        </dl>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md#setcurrentprogramscene">obs-websocket API docs</a> for this request</li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END SetCurrentProgramScene -->

<!-- TriggerStudioModeTransition -->
<script type="text/javascript">
    RED.nodes.registerType("TriggerStudioModeTransition", {
        category: "obs",
        color: "#F3B567",
        defaults: {
            name: {value: ""},
            transition: {value: ""},
            transitionType: {value: ""},
            transitionTime: {value: ""},
            transitionTimeType: {value: ""},
            obsInstance: {type: "obs-instance", required: true}
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name||"TriggerStudioModeTransition";
        },
        oneditprepare: function() {
            let noneTypeDef = {
                value: "none",
                label: "None",
                hasValue: false,
                icon: "fa fa-times-circle-o"
            };
            var transitionTypeDef = {
                    value: "transition",
                    label: "Transition",
                    hasValue: false,
                    icon: "/red/images/typedInput/bool.svg",
                    options: null
            };
            let transitionTypedInputObj = {
                default: "none",
                typeField: "#node-input-transitionType",
                types: [noneTypeDef, transitionTypeDef, "str", "msg", "flow", "global"]
            };

            // Hide/show warning messages as needed
            $("#ttp-offlinemessage").hide();
            $("#ttp-redeploymessage").hide();
            if (!this.obsInstance) $("#ttp-redeploymessage").show();

            // http request to backend for obs transition list
            $.getJSON(`nr-contrib-obs-ws/${this.obsInstance}/list/transitions`, (data) => {
                transitionTypeDef.options = data.transitions.map(s => s.transitionName);
            }).fail(() => { //503 = obs not connected
                if (this.transitionType == "transition" && this.transition !== "") transitionTypeDef.options = [this.transition];
                $("#ttp-offlinemessage").show();
            }).always(() => {
                $("#node-input-transition").typedInput(transitionTypedInputObj);
            });

            $("#node-input-transitionTime").typedInput({
                default: "none",
                typeField: "#node-input-transitionTimeType",
                types: [noneTypeDef, "num", "jsonata", "msg", "flow", "global"]
            });

            // Hide and show transition time setting on transition settings change
            $("#node-input-transition").on('change', (type, value) => {
                value == "none" ? $("#ttp-transistionTime").hide() : $("#ttp-transistionTime").show();
            });
        }
    });
</script>

<script type="text/html" data-template-name="TriggerStudioModeTransition">
    <div class="form-row" style="color:red;display:none;" id="ttp-offlinemessage">Not connected to obs!</div>
    <div class="form-row" style="color:red;display:none;" id="ttp-redeploymessage">
        To access available obs transitions, please select a valid OBS Instance, redeploy and open this again.
    </div>
    <div class="form-row">
        <label for="node-input-obsInstance"><i class="fa fa-globe"></i> OBS Instance</label>
        <input type="text" id="node-input-obsInstance">
    </div>
    <div class="form-row">
        <label for="node-input-transition">Transition</label>
        <input type="text" id="node-input-transition" style="width:70%">
        <input type="hidden" id="node-input-transitionType">
    </div>
    <div class="form-row" id="ttp-transistionTime">
        <label for="node-input-transition">Transition Time</label>
        <input type="text" id="node-input-transitionTime" style="width:70%">
        <input type="hidden" id="node-input-transitionTimeType">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name (optional)">
    </div>
</script>

<script type="text/html" data-help-name="TriggerStudioModeTransition">
    <p>This node triggers the transition to program action which will take the current preview scene to program.</p>
    <p>By automatically sending 2 different requests before that it can optionally change the transition and set it's duration.</p>
    <p>It's the same action that happens in obs when pressing the "Transition" button in studio mode.</p>
    <p>Use a catch node to catch request errors.</p>
    <p>To automatically fetch available transitions from obs make sure your obs is running and you deployed the node at least once after adding it.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">transition (configurable) <span class="property-type">string</span></dt>
        <dd>The optional transition name to use.</dd>
        <dt class="optional">transitionTime (configurable) <span class="property-type">string</span></dt>
        <dd>The optional transition time to use for the specified transition.</dd>
    </dl>
    <h3>Outputs</h3>
    <ol class="node-ports">
        <dl class="message-properties">
            <dt>payload <span class="property-type">object</span></dt>
            <dd>The response of the request if successful.</dd>
        </dl>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md#triggerstudiomodetransition">obs-websocket API docs</a> for this request</li>
        <li><a href="https://github.com/lebaston100/node-red-contrib-obs-ws">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
<!-- END TriggerStudioModeTransition -->